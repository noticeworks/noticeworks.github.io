!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("picturefill"),require("@odopod/odo-viewport")):"function"==typeof define&&define.amd?define(["picturefill","@odopod/odo-viewport"],t):e.OdoResponsiveImages=t(e.picturefill,e.OdoViewport)}(this,function(e,t){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t;var r=function(e,t,r){var o,n,a,i,s;function d(){var l=Date.now()-i;l<t&&l>=0?o=setTimeout(d,t-l):(o=null,r||(s=e.apply(a,n),a=n=null))}null==t&&(t=100);var l=function(){a=this,n=arguments,i=Date.now();var l=r&&!o;return o||(o=setTimeout(d,t)),l&&(s=e.apply(a,n),a=n=null),s};return l.clear=function(){o&&(clearTimeout(o),o=null)},l.flush=function(){o&&(s=e.apply(a,n),a=n=null,clearTimeout(o),o=null)},l},o=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")};function n(e){return Array.isArray(e)?e:e&&"number"==typeof e.length?Array.from(e):[e]}var a=function(){function a(){o(this,a),this.ClassName={IMAGE:"odo-responsive-img",LOADED:"odo-responsive-img--loaded"},this.images=[],this._imageLoadHandler=this._handleImageLoad.bind(this),this._imageInViewHandler=this._handleImageInView.bind(this),this.updateOffsets=r(this._update,a.DEBOUNCE_TIME)}return a.prototype.initialize=function(){this._add(Array.from(document.querySelectorAll("."+this.ClassName.IMAGE+":not(picture)")))},a.prototype._add=function(e){var r=this,o=e.map(function(e){return r._getViewportOptions(e)}),n=t.add(o);this.images=this.images.concat(n.map(function(t,r){return{id:t,element:e[r]}}))},a.prototype._getViewportOptions=function(e){return{element:e,threshold:e.getAttribute("data-threshold")||0,enter:this._imageInViewHandler}},a.prototype._handleImageInView=function(e){this._loadImage(e.element)},a.prototype._loadImage=function(t){var r=t.querySelector("img");if(!r)throw new Error("Unable to find <img> element within Odo Responsive Images placeholder.");var o=r.getAttribute("data-srcset");if(null!==o)r.srcset=o,r.setAttribute("srcset",o),r.removeAttribute("data-srcset"),t._odoResponsiveImageUsed=!0;else{var n=t.parentElement,a=document.createElement("picture");a.className=t.className,function(e,t){for(var r=document.createDocumentFragment(),o=Array.from(e.childNodes),n=0;n<o.length;n++)"NOSCRIPT"!==o[n].nodeName&&r.appendChild(o[n]);t.appendChild(r)}(t,a);var i=t.getAttribute("data-type");i&&a.setAttribute("data-type",i),r=a.querySelector("img"),n.replaceChild(a,t),a._odoResponsiveImageUsed=!0}this._removeImageEntry(t),this.isImageLoaded(r)&&setTimeout(this._handleImageLoad.bind(this,{target:r}),30),r.addEventListener("load",this._imageLoadHandler,!1),r.addEventListener("error",this._imageLoadHandler,!1),e({elements:[r]})},a.prototype._getImageIndexByPlaceholder=function(e){for(var t=null,r=0,o=this.images.length;r<o;r++)if(this.images[r].element===e){t=r;break}return t},a.prototype._removeImageEntry=function(e){var r=this._getImageIndexByPlaceholder(e);null!==r&&(t.remove(this.images[r].id),this.images.splice(r,1))},a.prototype.isImageLoaded=function(e){return e.naturalWidth>0},a.prototype._isBackgroundImage=function(e){return"background"===e.parentElement.getAttribute("data-type")},a.prototype._isUnloadedResponsiveImage=function(e){if(!(t=e)||1!==t.nodeType)throw new TypeError('Odo Responsive Images requires an element. Got: "'+e+'"');var t;if(!e.classList.contains(this.ClassName.IMAGE))throw new TypeError(e+" is not a Odo Responsive Image.");return!0!==e._odoResponsiveImageUsed},a.prototype.isUntrackedImage=function(e){return null===this._getImageIndexByPlaceholder(e)},a.prototype._handleImageLoad=function(e){var t=this,r=e.target;r.parentNode&&(this.updateOffsets(),this._isBackgroundImage(r)?this._updateBackgroundImage(r):this._removeImageHandlers(r),requestAnimationFrame(function(){r.parentNode.classList.add(t.ClassName.LOADED)}))},a.prototype._updateBackgroundImage=function(e){e.parentNode.style.backgroundImage='url("'+(e.currentSrc||e.src)+'")'},a.prototype._update=function(){t.update()},a.prototype._removeImageHandlers=function(e){e&&(e.removeEventListener("load",this._imageLoadHandler,!1),e.removeEventListener("error",this._imageLoadHandler,!1))},a.prototype.flush=function(){var e=this;this.images.forEach(function(r){var o=r.element.querySelector("img");e._removeImageHandlers(o),t.remove(r.id)}),this.images.length=0;var r="."+this.ClassName.IMAGE+'[data-type="background"] img';Array.from(document.querySelectorAll(r)).forEach(function(t){e._removeImageHandlers(t)})},a.prototype.remove=function(e){var t=this;n(e).forEach(function(e){t._removeImageEntry(e),t._removeImageHandlers(e.querySelector("img"))})},a.prototype.add=function(e){var t=n(e).filter(this._isUnloadedResponsiveImage,this).filter(this.isUntrackedImage,this);0!==t.length&&this._add(t)},a.prototype.load=function(e){n(e).filter(this._isUnloadedResponsiveImage,this).forEach(this._loadImage,this)},a}();return a.DEBOUNCE_TIME=300,new a});
//# sourceMappingURL=odo-responsive-images.min.js.map
